/* 
 * Copyright 2016 Damian Terlecki.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function latToMercatorY(a){var b=Math.sin(degToRad(a));return Math.log((1+b)/(1-b))/2}function gudermannian(a){return Math.atan(Math.sinh(a))}function mu(a){switch(a.surface){case"wood":case"tartan":case"clay":case"metal":return 1;case"concrete":return 1;case"paved":case"paving_stones":case"paving_stones:30":case"concrete:lanes":case"concrete:plates":return.95;case"asphalt":return.9;case"solid":case"sett":default:return.85;case"mostly solid":case"grass_paver":case"fine_gravel":return.8;case"even mixture of hard and soft materials":return.75;case"mostly soft":case"cobblestone":return.7;case"soft":case"sand":case"compacted":case"pebblestone":return.65;case null:case"unpaved":case"other":case"gravel":case"earth":return.7;case"grass":case"dirt":return.75;case"mud":return.5}}function radToDeg(a){return a*(180/Math.PI)}function degToRad(a){return a*(Math.PI/180)}function ktphToMps(a){return kphToMps(ktphToKph(a))}function ktphToKph(a){return 1.852*a}function kphToMps(a){return 1e3*a/3600}function mpsToKph(a){return 3600*a/1e3}function jouleToKcal(a){return a/4184}function kelvinToCelsius(a){return a-273.15}function fat87ToKcal(a){return.87*a*9e3}function bmr(a,b,c,d){return 10*a+6.25*b-5*c+(d?5:-161)}function bmi(a,b){return 1e4*a/b/b}function met(a,b,c){return a/b/c}function parseXml(a){"use strict";var b,c;if(window.DOMParser?(b=new window.DOMParser,c=b.parseFromString(a,"text/xml")):(c=new window.ActiveXObject("Microsoft.XMLDOM"),c.async=!1,c.loadXML(a)),void 0===c||null===c)throw new Error("Error while parsing xml string.");return c}function xmlToJson(a){"use strict";var b={};if(a.nodeType===XmlNode.ELEMENT){if(a.attributes.length>0){b["@attributes"]={};for(var c=0;c<a.attributes.length;c++){var d=a.attributes.item(c);b["@attributes"][d.nodeName]=d.nodeValue}}}else a.nodeType==XmlNode.TEXT&&(b=a.nodeValue);if(a.hasChildNodes())for(var c=0;c<a.childNodes.length;c++){var e=a.childNodes.item(c),f=e.nodeName;if("undefined"==typeof b[f])b[f]=xmlToJson(e);else{if("undefined"==typeof b[f].push){var g=b[f];b[f]=[],b[f].push(g)}b[f].push(xmlToJson(e))}}return b}function selectionSortNamesValuesDesc(a,b){for(var c=0;c<b.length;c++){for(var d=c,e=c+1;e<b.length;e++)b[e]>b[d]&&(d=e);var f=b[c];b[c]=b[d],b[d]=f,f=a[c],a[c]=a[d],a[d]=f}}var RouteLoader=function(a,b=""){this.route=void 0,this.api={weatherOwmKey:a,googleMapJsKey:b},this.osmMaxDAngleSquare=9,this.loadedModules={loadingCallback:!1,map:!0,elevations:void 0,routeInfo:void 0,weather:void 0},this.onLoadingFinished=void 0,this.weatherCallback=void 0,this.routeInfoCallback=void 0,this.elevationsCallback=void 0,this.mapCallback=void 0};RouteLoader.prototype.getLicenses=function(){return{GoogleChart:"Read more at: https://developers.google.com/chart/terms",GoogleMaps:"Read more at: https://developers.google.com/maps/terms",OpenStreetMap:"The data is made available under ODbL. http://opendatacommons.org/licenses/odbl./",OpenWeatherMap:"OpenWeatherMap data is released under the terms and conditions of CC-BY-SA. Read more at: https://openweathermap.org/terms and https://openweathermap.desk.com/customer/portal/questions/14410510-question-about-licensing?t=535697",OverpassAPI:"No formal policy yet. Read more at https://wiki.openstreetmap.org/wiki/Talk:Overpass_API#Licensing",map2kcal:"Licensed under the Apache License, Version 2.0. Read more at: https://github.com/T3r1jj/map2kcal"}},RouteLoader.prototype.getAttributions=function(){return{GoogleChart:["Chart tools ©2015 Google","//developers.google.com/chart/"],GoogleMaps:["Map and elevations data ©2015 Google","//www.google.pl/maps"],OpenStreetMap:["Route highway/surface types data © OpenStreetMap contributors","//openstreetmap.org/copyright"],OpenWeatherMap:["Weather data OpenWeatherMap.org","//openweathermap.org/terms"],OverpassAPI:["Overpass API","//overpass-api.de/"],map2kcal:["map2kcal","//github.com/T3r1jj/map2kcal"]}},RouteLoader.prototype.finishLoadingModule=function(a,b){if(null==b?this.loaded[a]=!0:this.loaded[a]=b,this.loaded.loadingCallback)return!0;for(key in this.loaded)if(this.loaded.hasOwnProperty(key)&&"loadingCallback"!=key&&null==this.loaded[key])return!1;return this.loaded.loadingCallback=!0,this.loadedModules=this.loaded,delete this.loaded,null!=this.onLoadingFinished&&this.onLoadingFinished(),!0},RouteLoader.prototype.createRouteFromGpx=function(a){var b=a.target.result,c=parseXml(b);if(c){var d=xmlToJson(c);this.route=new Route,trkpts=d.gpx.trk.trkseg.trkpt;for(var e=0;e<trkpts.length;e++)this.route.addCoordinate(parseFloat(trkpts[e]["@attributes"].lat),parseFloat(trkpts[e]["@attributes"].lon));return this.route.processCoordinates(),this.route}throw Error("Failed to parse xml file")},RouteLoader.prototype.loadApi=function(){if(this.apiLoaded)return void this.loadRouteData();var a=document.createElement("script");a.src="https://maps.googleapis.com/maps/api/js?key="+this.api.googleMapJsKey,a.type="text/javascript";var b=this;a.onload=function(){b.loadRouteData()},document.getElementsByTagName("head")[0].appendChild(a),this.apiLoaded=!0},RouteLoader.prototype.loadRouteData=function(a=this.weatherCallback,b=this.routeInfoCallback,c=this.elevationsCallback,d=this.mapCallback){function e(a){a.loaded={loadingCallback:!1,map:!0,elevations:void 0,routeInfo:void 0,weather:void 0}}return e(this),null!=d&&d(),this.loadElevations(c),this.getRouteInfo(b),this.getWeather(a),this.route},RouteLoader.prototype.loadElevations=function(a){function d(b,d){"OK"!==d?(c.route.elevations=null,c.route.processElevations(),null!=a&&a(d),c.finishLoadingModule("elevations",d)):(c.route.elevations=b,c.route.processElevations(),null!=a&&a(),c.finishLoadingModule("elevations"))}var b=new google.maps.ElevationService,c=this;b.getElevationAlongPath({path:c.route.coordinates,samples:512},d)},RouteLoader.prototype.getRouteInfo=function(a){var b=this,c=b.route.bbox.maxLat-b.route.bbox.minLat,d=b.route.bbox.maxLng-b.route.bbox.maxLat;if(c*d>this.osmMaxDAngleSquare){var e="Data limited to "+this.osmMaxDAngleSquare+"square angle of route bounding box due to big data size";return null!=a&&a(e),void b.finishLoadingModule("routeInfo",e)}return getResponse("http://overpass-api.de/api/xapi?way[bbox="+b.route.bbox.minLng+","+b.route.bbox.minLat+","+b.route.bbox.maxLng+","+b.route.bbox.maxLat+"][highway=*]","document",function(c,d){if(null!=c)a(c),b.finishLoadingModule("routeInfo",c);else try{roadsInfoJson=xmlToJson(d),b.route.parseOsmData(roadsInfoJson),null!=a&&a(),b.finishLoadingModule("routeInfo")}catch(c){null!=a&&a(c),b.finishLoadingModule("routeInfo",c)}})},RouteLoader.prototype.getWeather=function(a){function d(a,b){var c=b.weather;if(null!=c){a.conditions=[],a.descriptions=[];for(var d=0;d<c.length;d++)a.conditions.push(c[d].main),a.descriptions.push(c[d].description)}a.cityName=b.name,a.time=new Date(1e3*parseInt(b.dt)),a.sunrise=new Date(1e3*parseInt(b.sys.sunrise)),a.sunset=new Date(1e3*parseInt(b.sys.sunset)),a.country=b.sys.country,a.cloudness=b.clouds.all/100;try{a.rainPast3h=b.rain["3h"]}catch(a){}try{a.snowPast3h=b.snow["3h"]}catch(a){}}var b=this,c=this.route.getCenterCoordinate();return getResponse("http://api.openweathermap.org/data/2.5/weather?lat="+c.lat+"&lon="+c.lng+"&APPID="+b.api.weatherOwmKey,"json",function(c,e){if(null!=c)b.route.weather=new Weather,b.route.processWeatherExercise(),null!=a&&a(c),b.finishLoadingModule("weather",c);else try{if("200"!=e.cod)throw e.message;var f=ktphToMps(e.wind.speed),g=degToRad(e.wind.deg),h=e.main.temp,i=100*e.main.pressure,j=e.main.humidity/100;b.route.weather=new Weather(i,h,j,f,g),d(b.route.weather,e),b.route.processWeatherExercise(),null!=a&&a(),b.finishLoadingModule("weather")}catch(c){b.route.weather=new Weather,b.route.processWeatherExercise(),null!=a&&a(c),b.finishLoadingModule("weather",c)}})};var getResponse=function(a,b,c){var d=new XMLHttpRequest;d.open("get",a,!0),d.responseType=b,d.onload=function(){var a=d.status;200==a?c(null,d.response):c(a)},d.send()},Route=function(){this.coordinates=[],this.sections=[],this.elevations=[],this.energy={E:0,Ed:0,Er:0,Es:0,Ea:0},this.bbox={minLat:0,maxLat:0,minLng:0,maxLng:0},this.weather=void 0,this.exercise=void 0};Route.prototype.addCoordinate=function(a,b){this.coordinates.push(new Coordinate(a,b))},Route.prototype.processCoordinates=function(){function a(a){for(var b=0;b<a.coordinates.length;b++){var c=a.coordinates[b];0===b?(a.bbox.minLat=a.bbox.maxLat=c.lat,a.bbox.minLng=a.bbox.maxLng=c.lng):(a.bbox.minLat=Math.min(a.bbox.minLat,c.lat),a.bbox.maxLat=Math.max(a.bbox.maxLat,c.lat),a.bbox.minLng=Math.min(a.bbox.minLng,c.lng),a.bbox.maxLng=Math.max(a.bbox.maxLng,c.lng))}}function b(a){a.sections=[];for(var b=1;b<a.coordinates.length;b++)section=new Section(a.coordinates[b-1],a.coordinates[b]),a.sections.push(section)}a(this),b(this)},Route.prototype.getCenterCoordinate=function(){var a=latToMercatorY(this.bbox.maxLat),b=latToMercatorY(this.bbox.minLat),c=gudermannian((a+b)/2);return new Coordinate(radToDeg(c),(this.bbox.maxLng+this.bbox.minLng)/2)},Route.prototype.getMercatorCenterCoordinate=function(){var a=latToMercatorY(this.bbox.maxLat),b=latToMercatorY(this.bbox.minLat),c=gudermannian((a+b)/2);return new Coordinate(radToDeg(c),(this.bbox.maxLng+this.bbox.minLng)/2)},Route.prototype.processElevations=function(){function d(a){a.distance=Math.sqrt(a.slope*a.slope+a.distance*a.distance)}if(null==this.elevations||0==this.elevations.length){this.elevations=[];for(var a=0;a<this.coordinates.length;a++)elevations.push({elevation:0})}for(var a=0;a<this.sections.length;a++){var b=this.getElevationIndex(a),c=this.getElevationIndex(a+1);this.sections[a].slope=this.elevations[c].elevation-this.elevations[b].elevation,this.sections[a].elevation=(this.elevations[c].elevation+this.elevations[b].elevation)/2,d(this.sections[a])}},Route.prototype.getElevationIndex=function(a){var b=(this.elevations.length-1)/this.sections.length;return Math.round(b*a)},Route.prototype.getElevationCoordinate=function(a){var b=(this.coordinates.length-1)/this.elevations.length;return Math.round(b*a)},Route.prototype.processWeatherExercise=function(){for(var a=0;a<this.sections.length;a++)this.sections[a].headwind=this.weather.calculateHeadwind(this.sections[a].angle),this.sections[a].crosswind=this.weather.calculateCrosswind(this.sections[a].angle);this.calculateEnergy()},Route.prototype.calculateEnergy=function(){if(this.energy.E=0,this.energy.Ed=0,this.energy.Er=0,this.energy.Es=0,this.energy.Ea=0,0!=this.exercise.a)var a=this.exercise.vr/this.exercise.a,b=this.exercise.vr/2*a;else var b=0;for(var c=b,d=0,e=0;e<this.sections.length;e++){this.sections[e].headwind=this.weather.calculateHeadwind(this.sections[e].angle),this.sections[e].crosswind=this.weather.calculateCrosswind(this.sections[e].angle);var f=Math.min(this.sections[e].distance,c);c-=f;var g=this.exercise.Ea(f)+this.exercise.EBraking(this.sections[e],b);this.energy.Ea+=g;var h=this.exercise.E(this.sections[e],this.weather)+g,i=h+d;i<0?(d=i,this.sections[e].E=0):(d=0,this.sections[e].E=i),this.energy.E+=h,this.energy.Ed+=this.exercise.Ed(this.sections[e],this.weather),this.energy.Er+=this.exercise.Er(this.sections[e],this.weather),this.energy.Es+=this.exercise.Es(this.sections[e],this.weather)}},Route.prototype.parseOsmData=function(a){for(var b=0;b<this.coordinates.length;b++)this.coordinates[b].loadOsmRoadInfo(a);for(var b=0;b<this.sections.length;b++)null!=this.coordinates[b].highway&&null!=this.coordinates[b+1].highway&&(this.sections[b].highway=this.coordinates[b].highway,this.sections[b].surface=this.coordinates[b].surface)},Route.prototype.getHighways=function(){for(var a={},b=this.sections,d=(this.coordinates,0);d<b.length;d++)null!=b[d].highway?null==a[b[d].highway]?a[b[d].highway]=b[d].distance:a[b[d].highway]+=b[d].distance:null==a.undefined?a.undefined=b[d].distance:a.undefined+=b[d].distance;return a},Route.prototype.getSurfaces=function(){for(var a={},b=this.sections,d=(this.coordinates,0);d<b.length;d++)null!=b[d].highway?null==a[b[d].surface]?a[b[d].surface]=b[d].distance:a[b[d].surface]+=b[d].distance:null==a.undefined?a.undefined=b[d].distance:a.undefined+=b[d].distance;return a},Route.prototype.getDistance=function(){for(var a=0,b=0;b<this.sections.length;b++)a+=this.sections[b].distance;return a},Route.prototype.getSlope=function(){return this.elevations[this.elevations.length-1].elevation-this.elevations[0].elevation},Route.prototype.getTime=function(){return this.getDistance()/this.exercise.vr},Route.prototype.getAverageHeadwind=function(){for(var a=this.getDistance(),b=0,c=0;c<this.sections.length;c++)b+=this.sections[c].headwind*this.sections[c].distance;return b/a},Route.prototype.getAverageCrosswind=function(){for(var a=this.getDistance(),b=0,c=0;c<this.sections.length;c++)b+=this.sections[c].crosswind*this.sections[c].distance;return b/a},Route.prototype.getAverageAbsoluteCrosswind=function(){for(var a=this.getDistance(),b=0,c=0;c<this.sections.length;c++)b+=Math.abs(this.sections[c].crosswind)*this.sections[c].distance;return b/a},Route.prototype.getEnergyPerS=function(){return this.energy.E/this.getTime()},Route.prototype.getEnergyPerM=function(){return this.energy.E/this.getDistance()},Route.prototype.getSlope=function(){for(var a=0,b=0;b<this.sections.length;b++)a+=this.sections[b].slope;return a},Route.prototype.getGoogleMapZoom=function(a,b){function i(a,b,c){return Math.floor(Math.log(a/b/c)/Math.LN2)}var c={height:256,width:256},d=21,e=(this.bbox.maxLng-this.bbox.minLng)/360,f=(latToMercatorY(this.bbox.maxLat)-latToMercatorY(this.bbox.minLat))/(2*Math.PI),g=i(a,c.width,e),h=i(b,c.height,f);return Math.min(h,g,d)},Route.prototype.invert=function(){this.coordinates.reverse(),this.elevations.reverse(),this.sections.reverse();for(var a=0;a<this.sections.length;a++)this.sections[a].invert();this.calculateEnergy()};var Coordinate=function(a,b){this.lat=a,this.lng=b,this.highway=void 0,this.surface=void 0};Coordinate.prototype.loadOsmRoadInfo=function(a){function d(a,c,d){for(var e=a.osm.node,f=0;f<e.length;f++){var g=Math.abs(e[f]["@attributes"].lat-c),h=Math.abs(e[f]["@attributes"].lon-d);if(g<b&&h<b)if(null==i)var i={dLat:g,dLon:h,id:e[f]["@attributes"].id};else g<=i.dLat&&h<=i.dLon&&(i.dLat=g,i.dLon=h,i.id=e[f]["@attributes"].id)}return null==i?void 0:i.id}function e(a,b,c){null==b&&(this.highway=void 0);var d=a.osm.way;d.constructor===Array?f(d,b,c):g(d,b,c),l(c)}function f(a,b,c){for(var d=0;d<a.length;d++)g(a[d],b,c)}function g(a,b,c){var d=a.nd;d.constructor===Array?h(a,d,b,c):i(a,d,b,c)}function h(a,b,c,d){for(var e=0;e<b.length;e++)i(a,b[e],c,d)}function i(a,b,c,d){if(b["@attributes"].ref==c){var e=a.tag;e.constructor===Array?j(e,d):k(e,d)}}function j(a,b){for(var c=0;c<a.length;c++)k(a[c],b)}function k(a,b){"highway"==a["@attributes"].k?b.highway=a["@attributes"].v:"surface"==a["@attributes"].k?b.surface=a["@attributes"].v:"tracktype"==a["@attributes"].k&&(b.tracktype=a["@attributes"].v)}function l(a){null==a.surface&&(null==a.highway||"path"==a.highway?a.surface="other":"track"==a.highway?"grade1"==a.tracktype?a.surface="solid":"grade2"==a.tracktype?a.surface="mostly solid":"grade3"==a.tracktype?a.surface="even mixture of hard and soft materials":"grade4"==a.tracktype?a.surface="mostly soft":"grade5"==a.tracktype?a.surface="soft":a.surface="other":a.surface="asphalt")}var b=1e-6,c=d(a,this.lat,this.lng);e(a,c,this)};var Section=function(a,b){function c(a,b){try{return e(a,b)}catch(c){return d(a,b)}}function d(a,b,c=6371008){var d=degToRad(b.lat-a.lat),e=degToRad(b.lng-a.lng),f=Math.sin(d/2)*Math.sin(d/2)+Math.cos(degToRad(a.lat))*Math.cos(degToRad(b.lat))*Math.sin(e/2)*Math.sin(e/2),g=2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f)),h=c*g;return h}function e(a,b){var c=6378137,d=6356752.3142,e=1/298.257223563,f=degToRad(a.lng),g=degToRad(b.lng),h=degToRad(a.lat),i=degToRad(b.lat),j=g-f,k=(1-e)*Math.tan(h),l=1/Math.sqrt(1+k*k),m=k*l,n=(1-e)*Math.tan(i),o=1/Math.sqrt(1+n*n),p=n*o,q=j;do{var s=Math.sin(q),t=Math.cos(q),u=o*s*(o*s)+(l*p-m*o*t)*(l*p-m*o*t),v=Math.sqrt(u);if(0==v)return 0;var w=m*p+l*o*t,x=Math.atan2(v,w),y=l*o*s/v,z=1-y*y,A=w-2*m*p/z;isNaN(A)&&(A=0);var B=e/16*z*(4+e*(4-3*z)),C=q;q=j+(1-B)*e*y*(Sigma+B*v*(A+B*w*(-1+2*A*A)))}while(Math.abs(q-C)>1e-12&&--iterationLimit>0);if(0==iterationLimit)throw new Error("Vincenty's formulae failed to converge");var D=z*(c*c-d*d)/(d*d),E=1+D/16384*(4096+D*(-768+D*(320-175*D))),F=D/1024*(256+D*(-128+D*(74-47*D))),G=F*v*(A+F/4*(w*(-1+2*A*A)-F/6*A*(-3+4*v*v)*(-3+4*A*A)));return d*E*(x-G)}function f(a,b){for(var c=(g(a,b)+Math.PI/2)*-1;c<0;)c+=2*Math.PI;return c}function g(a,b){var c=b.lat-a.lat,d=b.lng-a.lng;return Math.atan2(c,d)}this.distance=c(a,b),this.highway=void 0,this.surface=void 0,this.elevation=0,this.headwind=0,this.crosswind=0,this.slope=0,this.P=0,this.lat=degToRad((a.lat+b.lat)/2),this.angle=f(a,b)};Section.prototype.s=function(){return this.slope/this.distance},Section.prototype.invert=function(){this.slope=-this.slope,this.angle+=Math.PI,this.headwind=-this.headwind,this.crosswind=-this.crosswind};var Weather=function(a=101325,b=293.15,c=.5,d=0,e=0,f=8.314){this.p=a,this.T=b,this.phi=c,this.R=f,this.windSpeed=d,this.windAngle=e,this.conditions=void 0,this.descriptions=void 0,this.cityName=void 0,this.time=void 0,this.sunrise=void 0,this.sunset=void 0,this.country=void 0,this.cloudness=void 0,this.rainPast3h=void 0,this.snowPast3h=void 0};Weather.prototype.getWindDirection=function(){var a=Math.round(this.windAngle/(Math.PI/8))%16;return directions=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"],directions[a]},Weather.prototype.getBeaufortNumber=function(){return Math.round(Math.pow(this.windSpeed/.836,2/3))},Weather.prototype.rho=function(){var a=.028964,b=.018016,c=6.1078*Math.pow(10,7.5*kelvinToCelsius(this.T)/(kelvinToCelsius(this.T)+237.3))*100,d=this.phi*c,e=this.p-d;return(e*a+d*b)/(this.R*this.T)},Weather.prototype.calculateHeadwind=function(a){return-Math.cos(this.windAngle-a)*this.windSpeed},Weather.prototype.calculateCrosswind=function(a){return Math.sin(this.windAngle-a)*this.windSpeed},Weather.prototype.g=function(a,b){return null!=b?this.g(a)-3.155e-7*b:null!=a?9.7803253359*(1+.00193185265241*Math.sin(a)*Math.sin(a))/Math.sqrt(1-.0066943799013*Math.sin(a)*Math.sin(a)):9.81};var Exercise=function(a,b,c,d,e,f){this.A=b,this.Cd=a,this.mExerciser=c,this.m=c,this.eta=d,this.vr=e,this.a=f,this.brakingEstimated=!1,this.brakeDistance=500};Exercise.prototype.Pinitial=function(a,b){return(this.Pd(a,b)+this.Pr(a,b)+this.Ps(a,b)+this.Pa())/this.eta},Exercise.prototype.P=function(a,b){return(this.Pd(a,b)+this.Pr(a,b)+this.Ps(a,b))/this.eta},Exercise.prototype.Pd=function(a,b){return this.Fd(a,b)*(this.vr+a.headwind)},Exercise.prototype.Fd=function(a,b){var c=this.vr+a.headwind;return.5*b.rho()*c*c*this.Cd*this.A},Exercise.prototype.Pa=function(){return this.vr*this.m*this.a},Exercise.prototype.PToW=function(a,b,c=this.vr){return a*b/c},Exercise.prototype.Einitial=function(a,b,c){return this.PToW(this.P(a,b),a.distance)+this.Ea(a,b,c)},Exercise.prototype.E=function(a,b){return this.PToW(this.P(a,b),a.distance)},Exercise.prototype.Ed=function(a,b){return this.PToW(this.Pd(a,b),a.distance)/this.eta},Exercise.prototype.Er=function(a,b){return this.PToW(this.Pr(a,b),a.distance)/this.eta},Exercise.prototype.Es=function(a,b){return this.PToW(this.Ps(a,b),a.distance)/this.eta},Exercise.prototype.Ea=function(a){return this.PToW(this.Pa(),a)/this.eta},Exercise.prototype.EBraking=function(a,b){return this.brakingEstimated?this.Ea(b)*a.distance/this.brakeDistance:0};var Cycling=function(a=1,b=.5,c=95,d=1,e=10,f=.5,g=0){Exercise.call(this,a,b,c,d,e,f),this.mw=g,this.name="Rolling"};Cycling.prototype=Object.create(Exercise.prototype),Cycling.prototype.constructor=Cycling,Cycling.prototype.Pa=function(){return this.vr*(this.m+this.mw)*this.a},Cycling.prototype.Pr=function(a,b){function c(a,b){function d(a){switch(a.surface){case"wood":case"tartan":case"clay":case"metal":return.001;case"concrete":return.002;case"paved":case"paving_stones":case"paving_stones:30":case"concrete:lanes":case"concrete:plates":return.003;case"asphalt":return.004;case"solid":case"sett":default:return.0045;case"mostly solid":case"grass_paver":case"fine_gravel":return.005;case"even mixture of hard and soft materials":return.006;case"mostly soft":case"cobblestone":return.007;case"soft":case"sand":case"compacted":case"pebblestone":return.008;case null:case"unpaved":case"other":case"gravel":case"earth":return.009;case"grass":case"dirt":return.01;case"mud":return.015}}var c=1+b/20;return d(a)*c}return this.vr*this.m*b.g(a.lat,a.elevation)*Math.cos(Math.atan(a.s()))*c(a,this.vr)},Cycling.prototype.Ps=function(a,b){return this.vr*this.m*b.g(a.lat,a.elevation)*Math.sin(Math.atan(a.s()))};var CityCycling=function(a=kphToMps(20),b=80,c=true){Cycling.call(this,1.15,.632,b,.8,a,.5,5);var d=15;this.m=b+d,this.brakingEstimated=c};CityCycling.prototype=Object.create(Cycling.prototype),CityCycling.prototype.constructor=CityCycling;var RaceCycling=function(a=kphToMps(30),b=80,c=false){Cycling.call(this,.88,.32,b,.95,a,1.5,2);var d=5;this.m=b+d,this.brakingEstimated=c};RaceCycling.prototype=Object.create(Cycling.prototype),RaceCycling.prototype.constructor=CityCycling;var Running=function(a=kphToMps(15),b=80,c=false){Exercise.call(this,1.27,.55,b,.55,a,2.5),this.brakingEstimated=c,this.name="Running"};Running.prototype=Object.create(Exercise.prototype),Running.prototype.constructor=Running,Running.prototype.Pr=function(a,b){return this.vr*this.m*b.g(a.lat,a.elevation)*Math.cos(Math.atan(a.s()))/5/mu(a)},Running.prototype.Ps=function(a,b){return this.vr*this.m*b.g(a.lat,a.elevation)*Math.sin(Math.atan(a.s()))/5};var Walking=function(a=kphToMps(5),b=80,c=false){Exercise.call(this,1.27,.55,b,.55,a,1),this.brakingEstimated=c,this.name="Walking"};Walking.prototype=Object.create(Exercise.prototype),Walking.prototype.constructor=Walking,Walking.prototype.Pr=function(a,b){var c=b.g(a.lat,a.elevation),d=1;return this.m*c/Math.PI*Math.sqrt(3*c*d/2)*(1-Math.sqrt(1-Math.PI*Math.PI*this.vr*this.vr/(6*c*d)))*Math.cos(Math.atan(a.s()))/mu(a)},Walking.prototype.Ps=function(a,b){var c=b.g(a.lat,a.elevation),d=1;return this.m*c/Math.PI*Math.sqrt(3*c*d/2)*(1-Math.sqrt(1-Math.PI*Math.PI*this.vr*this.vr/(6*c*d)))*Math.sin(Math.atan(a.s()))};var XmlNode={ELEMENT:1,MEDIUM:2,TEXT:3};!function(){var a=document.createElement("script");a.src="https://www.gstatic.com/charts/loader.js",a.type="text/javascript",a.onload=function(){google.charts.load("current",{packages:["corechart"]})},document.getElementsByTagName("head")[0].appendChild(a)}();var ChartDrawer=function(a=500,b=150,c,d){this.width=a,this.height=b,this.options_fullStacked={isStacked:"percent",width:this.width,height:this.height,legend:{position:"bottom",alignment:"start"},hAxis:{minValue:0,ticks:[0,.3,.6,.9,1]},tooltip:{isHtml:!0}},this.tooltipColumn={type:"string",role:"tooltip",p:{html:!0}},this.gMap=d,this.route=c,this.strokeColor="#FFFF00",this.strokeOpacity=1,this.strokeWeight=5,this.zIndex=200};ChartDrawer.prototype.createCustomHtmlTooltip=function(a,b,c,d,e,f){return null!=e?'<div style="padding:5px 5px 5px 5px; font-family: Arial; font-size: 11px;">'+a+": <b>"+b+c+"</b>, <br>"+d+": <b>"+e+f+"</b></div>":null!=d?'<div style="padding:5px 5px 5px 5px; font-family: Arial; font-size: 11px;">'+a+": <b>"+b+c+"</b> "+d:null!=c?'<div style="padding:5px 5px 5px 5px; font-family: Arial; font-size: 11px;">'+a+": <b>"+b+c+"</b>":'<div style="padding:5px 5px 5px 5px; font-family: Arial; font-size: 11px;">'+a+": <b>"+b+"</b>"},ChartDrawer.prototype.plotElevation=function(a){function m(a){var d=b.coordinates[b.getElevationCoordinate(a.row)];l=new google.maps.Polyline({path:[d,d],geodesic:!0,strokeColor:h.strokeColor,strokeOpacity:h.strokeOpacity,strokeWeight:2*h.strokeWeight,zIndex:h.zIndex}),l.setMap(c)}function n(a){l.setMap(null),l=void 0}var b=this.route,c=this.gMap,d=b.elevations,e=document.getElementById(a),f=new google.visualization.AreaChart(e),g=new google.visualization.DataTable,h=this;g.addColumn("number","Distance [km]"),g.addColumn("number","Elevation [m]"),g.addColumn(this.tooltipColumn);for(var i=b.getDistance(),j=0;j<d.length;j++){var k=i*j/(d.length-1)/1e3;g.addRow([k,d[j].elevation,this.createCustomHtmlTooltip("Elevation",d[j].elevation.toFixed(2)," m","Distance",k.toFixed(3)," km")])}if(f.draw(g,{title:"Route elevations",width:this.width,height:this.height,legend:"none",titleY:"Elevation [m]",titleX:"Distance [km]",tooltip:{isHtml:!0},curveType:"function"}),null!=c){var l;google.visualization.events.addListener(f,"onmouseover",m),google.visualization.events.addListener(f,"onmouseout",n)}},ChartDrawer.prototype.plotHighways=function(a){function q(a){p=[];var d=parseInt(a.column/2),e=h[d];"undefined"==e&&(e=null);for(var f=0;f<b.sections.length;f++)if(b.sections[f].highway==e){var i=new google.maps.Polyline({path:[b.coordinates[f],b.coordinates[f+1]],geodesic:!0,strokeColor:g.strokeColor,strokeOpacity:g.strokeOpacity,strokeWeight:g.strokeWeight,zIndex:g.zIndex});i.setMap(c),p.push(i)}}function r(a){for(var b=0;b<p.length;b++)p[b].setMap(null);p=void 0}var b=this.route,c=this.gMap,d=b.getHighways(),e=document.getElementById(a),f=new google.visualization.BarChart(e),g=this,h=[],i=[],j=[];for(var k in d)h.push(k),i.push(d[k]);selectionSortNamesValuesDesc(h,i);for(var l=0;l<h.length;l++)j.push(this.createCustomHtmlTooltip("Higway type",h[l]));var m=new google.visualization.DataTable;m.addColumn("string","Highway type");for(var n=["Highway"],l=0;l<j.length;l++)m.addColumn("number",h[l]),n.push(i[l]),m.addColumn(this.tooltipColumn),n.push(j[l]);m.addRows([n]);var o=new google.visualization.DataView(m);if(this.options_fullStacked.title="Highway types en route",f.draw(o,this.options_fullStacked),null!=c){var p;google.visualization.events.addListener(f,"onmouseover",q),google.visualization.events.addListener(f,"onmouseout",r)}},ChartDrawer.prototype.plotSurfaces=function(a){function q(a){p=[];var d=parseInt(a.column/2),e=h[d];"undefined"==e&&(e=null);for(var f=0;f<b.sections.length;f++)if(b.sections[f].surface==e){var i=new google.maps.Polyline({path:[b.coordinates[f],b.coordinates[f+1]],geodesic:!0,strokeColor:g.strokeColor,strokeOpacity:g.strokeOpacity,strokeWeight:g.strokeWeight,zIndex:g.zIndex});i.setMap(c),p.push(i)}}function r(a){for(var b=0;b<p.length;b++)p[b].setMap(null);p=void 0}var b=this.route,c=this.gMap,d=b.getSurfaces(),e=document.getElementById(a),f=new google.visualization.BarChart(e),g=this,h=[],i=[],j=[];for(var k in d)h.push(k),i.push(d[k]);selectionSortNamesValuesDesc(h,i);for(var l=0;l<h.length;l++)j.push(this.createCustomHtmlTooltip("Surface type",h[l]));var m=new google.visualization.DataTable;m.addColumn("string","Surface type");for(var n=["Surface"],l=0;l<j.length;l++)m.addColumn("number",h[l]),n.push(i[l]),m.addColumn(this.tooltipColumn),n.push(j[l]);m.addRows([n]);var o=new google.visualization.DataView(m);if(this.options_fullStacked.title="Surface types en route",f.draw(o,this.options_fullStacked),null!=c){var p;google.visualization.events.addListener(f,"onmouseover",q),google.visualization.events.addListener(f,"onmouseout",r)}},ChartDrawer.prototype.plotHeadwind=function(a){function m(a){l=new google.maps.Polyline({path:[b.coordinates[a.row],b.coordinates[a.row+1]],geodesic:!0,strokeColor:g.strokeColor,strokeOpacity:g.strokeOpacity,strokeWeight:g.strokeWeight,zIndex:g.zIndex}),l.setMap(c)}function n(a){l.setMap(null),l=void 0}var b=this.route,c=this.gMap,d=document.getElementById(a),e=new google.visualization.AreaChart(d),f=new google.visualization.DataTable,g=this;f.addColumn("number","Distance [km]"),f.addColumn("number","Headwind (positive) [km/h]"),f.addColumn(this.tooltipColumn),f.addColumn("number","Headwind (negative) [km/h]"),f.addColumn(this.tooltipColumn);for(var h=0,i=0;i<b.sections.length;i++){h+=b.sections[i].distance/1e3;var j=mpsToKph(b.sections[i].headwind),k=this.createCustomHtmlTooltip("Headwind",j.toFixed(2)," km/h","Distance",h.toFixed(3)," km");j>0?f.addRow([h,j,k,null,null]):f.addRow([h,null,null,j,k])}if(e.draw(f,{title:"Headwind",width:this.width,height:this.height,legend:"none",titleY:"Headwind [km/h]",titleX:"Distance [km]",tooltip:{isHtml:!0},curveType:"function",colors:["red","green"]}),null!=c){var l;google.visualization.events.addListener(e,"onmouseover",m),google.visualization.events.addListener(e,"onmouseout",n)}},ChartDrawer.prototype.plotCrosswind=function(a){function n(a){m=new google.maps.Polyline({path:[b.coordinates[a.row],b.coordinates[a.row+1]],geodesic:!0,strokeColor:g.strokeColor,strokeOpacity:g.strokeOpacity,strokeWeight:g.strokeWeight,zIndex:g.zIndex}),m.setMap(c)}function o(a){m.setMap(null),m=void 0}var b=this.route,c=this.gMap,d=document.getElementById(a),e=new google.visualization.AreaChart(d),f=new google.visualization.DataTable,g=this;f.addColumn("number","Distance [km]"),f.addColumn("number","Crosswind (from left) [km/h]"),f.addColumn(this.tooltipColumn),f.addColumn("number","Crosswind (from right) [km/h]"),f.addColumn(this.tooltipColumn);for(var h=0,i=0;i<b.sections.length;i++){h+=b.sections[i].distance/1e3;var j=mpsToKph(b.sections[i].crosswind);if(j>0){var k=this.createCustomHtmlTooltip("Crosswind (from left)",j.toFixed(2)," km/h","Distance",h.toFixed(3)," km");f.addRow([h,j,k,null,null])}else{var k=this.createCustomHtmlTooltip("Crosswind (from right)",j.toFixed(2)," km/h","Distance",h.toFixed(3)," km");f.addRow([h,null,null,j,k])}}var l=new google.visualization.ArrowFormat;if(l.format(f,1),e.draw(f,{title:"Crosswind",width:this.width,height:this.height,legend:"none",titleY:"Crosswind [km/h]",titleX:"Distance [km]",tooltip:{isHtml:!0},curveType:"function",colors:["orange","purple"]}),null!=c){var m;google.visualization.events.addListener(e,"onmouseover",n),google.visualization.events.addListener(e,"onmouseout",o)}},ChartDrawer.prototype.plotKcal=function(a){function n(a){for(var d=[],e=a.row+1,f=0;f<=e;f++)d.push(b.coordinates[f]);m=new google.maps.Polyline({path:d,geodesic:!0,strokeColor:g.strokeColor,strokeOpacity:g.strokeOpacity,strokeWeight:g.strokeWeight,zIndex:g.zIndex}),m.setMap(c)}function o(a){m.setMap(null),m=void 0}var b=this.route,c=this.gMap,d=document.getElementById(a),e=new google.visualization.AreaChart(d),f=new google.visualization.DataTable,g=this;f.addColumn("number","Distance [km]"),f.addColumn("number","kcal"),f.addColumn(this.tooltipColumn);var h=[],i=0,j=0;h.push([0,0,this.createCustomHtmlTooltip("Energy","0"," kcal","Distance","0"," km/h")]);for(var k=0;k<b.sections.length;k++)i+=b.sections[k].distance/1e3,j+=jouleToKcal(b.sections[k].E),h.push([i,j,this.createCustomHtmlTooltip("Energy",j.toFixed(3)," kcal","Distance",i.toFixed(3)," km")]);f.addRows(h);var l={title:"Energy depletion",legend:"none",titleX:"Distance [km]",titleY:"Cumulative energy [kcal]",width:this.width,height:this.height,tooltip:{isHtml:!0}};if(e.draw(f,l),null!=c){var m;google.visualization.events.addListener(e,"onmouseover",n),google.visualization.events.addListener(e,"onmouseout",o)}},ChartDrawer.prototype.plotE=function(a){var b=document.getElementById(a),c=new google.visualization.BarChart(b),d=Math.abs(this.route.energy.Ed)+Math.abs(this.route.energy.Ea)+Math.abs(this.route.energy.Es)+Math.abs(this.route.energy.Er),e=100*this.route.energy.Ed/d,f=100*this.route.energy.Ea/d,g=100*this.route.energy.Es/d,h=100*this.route.energy.Er/d,i="%",j=" of total absolute energy",k=google.visualization.arrayToDataTable([["Energy","kcal",this.tooltipColumn,{role:"style"}],["Air drag",e,this.createCustomHtmlTooltip("Air drag",e.toFixed(2),i+j,"Air drag energy",jouleToKcal(this.route.energy.Ed).toFixed(3)," kcal"),""],[this.route.exercise.name,h,this.createCustomHtmlTooltip(this.route.exercise.name,h.toFixed(2),i+j,this.route.exercise.name+" energy",jouleToKcal(this.route.energy.Er).toFixed(3)," kcal"),""],["Climbing",g,this.createCustomHtmlTooltip("Climbing",g.toFixed(2),i+j,"Climbing energy",jouleToKcal(this.route.energy.Es).toFixed(3)," kcal"),""],["Acceleration",f,this.createCustomHtmlTooltip("Acceleration",f.toFixed(2),i+j,"Acceleration energy",jouleToKcal(this.route.energy.Ea).toFixed(3)," kcal"),""]]);
k.sort([{column:1,desc:!0}]),k.setCell(0,3,"red"),k.setCell(1,3,"orange"),k.setCell(2,3,"yellow"),h>0?k.setCell(3,3,"green"):k.setCell(3,3,"blue");var l={title:"Energy portions",legend:"none",titleX:"% of total absolute energy",pieHole:.4,width:this.width,height:this.height,tooltip:{isHtml:!0}};c.draw(k,l)};